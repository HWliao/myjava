<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.leyoujia.coa.zc.mall.dao.erp.IJhsCommodityDAO">

  <select id="listCommoditiesForApp" resultType="com.leyoujia.coa.zc.mall.domain.mall.AppCommodityDto">
    SELECT
      jc.ID AS commodityId,
      jc.TITLE AS title,
      jc.CATEGORY_ID AS categoryId,
      js.SUB_NAME AS categoryName,
      jc.SHORT_NAME AS shortName,
      jc.PHOTO_URL AS photoUrl,
      jc.COUNT AS count,
      jc.PRICE AS price,
      jc.PAY_METHOD AS payMethod,
      jc.EXCHANGE_CONDITION AS exchangeCondition,
      <choose>
        <when test="workerId != null and workerId != ''">
          (SELECT jto.ID FROM JHS_TRADE_ORDER jto WHERE jto.COMMODITY_ID = jc.ID AND jto.WORKER_ID = #{workerId} AND jto.EXCHANGE_METHOD = 1 AND jto.`STATUS` IN ( 0, 2, 3, 4, 5, 8, 40, 41, 42 ) LIMIT 1 ) AS orderId,
          (SELECT jto.`STATUS` FROM JHS_TRADE_ORDER jto WHERE jto.COMMODITY_ID = jc.ID AND jto.WORKER_ID = #{workerId} AND jto.EXCHANGE_METHOD = 1 AND jto.`STATUS` IN ( 0, 2, 3, 4, 5, 8, 40, 41, 42 ) LIMIT 1 ) AS orderStatus
        </when>
        <otherwise>
          NULL as orderId,
          NULL as orderStatus
        </otherwise>
      </choose>
      FROM
      JHS_COMMODITY jc
      LEFT JOIN JHS_SUBJECT js ON js.ID = jc.CATEGORY_ID
    WHERE
      jc.CHANNEL_HAPPY_OFFICE = 1
      AND jc.IS_DOWN = 0
      AND jc.`STATUS` = 1
  </select>
  <sql id="by_workerId_where_sql">
    WHERE
      jc.IS_DOWN = 0
      AND jc.`STATUS` = 1
      <choose>
        <when test="from != null and from == 2">
          AND jc.CHANNEL_HAPPY_OFFICE = 1
        </when>
        <when test="from != null and from == 3">
          AND jc.CHANNEL_HOUSING_RESOURCES = 1
        </when>
        <otherwise>
          <!-- nothing -->
        </otherwise>
      </choose>
      <if test="categoryIds != null and categoryIds.size() > 0">
        AND jc.CATEGORY_ID IN
        <foreach collection="categoryIds" item="categoryId" open="(" separator="," close=")">
          #{categoryId}
        </foreach>
      </if>
  </sql>
  <select id="countCommoditesByWorkerId" resultType="java.lang.Integer">
    SELECT
      COUNT(*)
    FROM
      JHS_COMMODITY jc
    <include refid="by_workerId_where_sql"/>
  </select>
  <select id="listCommoditiesByWorkerId" resultType="com.leyoujia.coa.zc.client.mall.domain.CommodityDto">
    SELECT
      jc.ID AS id,
      jc.TITLE AS title,
      jc.CATEGORY_ID AS categoryId,
      js.SUB_NAME AS categoryName,
      jc.SHORT_NAME AS shortName,
      jc.PHOTO_URL AS image,
      jc.COUNT AS count,
      jc.PRICE AS price,
      jc.PAY_METHOD AS payMethod,
      jc.EXCHANGE_CONDITION AS exchangeCondition ,
      <choose>
        <when test="workerId != null and workerId != ''">
          (SELECT jto.ID FROM JHS_TRADE_ORDER jto WHERE jto.COMMODITY_ID = jc.ID AND jto.WORKER_ID = #{workerId} AND jto.EXCHANGE_METHOD = 1 AND jto.`STATUS` IN ( 0, 2, 3, 4, 5, 8, 40, 41, 42 ) LIMIT 1 ) AS orderId,
          (SELECT jto.`STATUS` FROM JHS_TRADE_ORDER jto WHERE jto.COMMODITY_ID = jc.ID AND jto.WORKER_ID = #{workerId} AND jto.EXCHANGE_METHOD = 1 AND jto.`STATUS` IN ( 0, 2, 3, 4, 5, 8, 40, 41, 42 ) LIMIT 1 ) AS orderStatus
        </when>
        <otherwise>
          NULL AS orderId,
          NULL AS orderStatus
        </otherwise>
      </choose>
      FROM
      JHS_COMMODITY jc
      LEFT JOIN JHS_SUBJECT js ON js.ID = jc.CATEGORY_ID
    <include refid="by_workerId_where_sql"/>
    ORDER BY
    <if test="workerId != null and workerId != ''">
      CASE
        WHEN EXISTS (
          SELECT
            *
          FROM
            JHS_TRADE_ORDER jto
          WHERE
            jto.COMMODITY_ID = jc.ID
          AND jto.WORKER_ID = '02013911'
          AND jto.EXCHANGE_METHOD = 1
          AND jto.`STATUS` IN ( 0, 2, 3, 4, 5, 8, 40, 41, 42 )
        ) THEN 1
        ELSE 0
      END,
    </if>
      jc.SORT_NUM,
      jc.CREATE_DATE
    <if test="page != null">
      LIMIT #{page.startRow},#{page.pageSize}
    </if>
  </select>
</mapper>
